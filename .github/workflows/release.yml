name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build dev container image
        run: docker build -t zeropoint-agent-dev:latest .
      
      - name: Build everything in container
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e VERSION="${{ github.event.release.tag_name }}" \
            -e ARTIFACTS_DIR="/workspace/artifacts" \
            -e GOOS="${{ matrix.goos }}" \
            -e GOARCH="${{ matrix.goarch }}" \
            -e CGO_ENABLED=0 \
            zeropoint-agent-dev:latest \
            bash -c "
              set -e
              # Build binary for this architecture
              go build -v \
                -ldflags='-s -w -extldflags \"-static\" -X main.version=${{ github.event.release.tag_name }}' \
                -o zeropoint-agent \
                ./cmd/zeropoint-agent
              
              # Generate swagger/clients/web (only needed once, but safe to do per-arch)
              if [ '${{ matrix.goos }}' = 'linux' ] && [ '${{ matrix.goarch }}' = 'amd64' ]; then
                echo 'Generating OpenAPI specs and client libraries...'
                ./scripts/generate-swagger.sh
                ./scripts/generate-clients.sh
                
                echo 'Building web UI...'
                npm install
                npm run build -- --mode production
              fi
            "
      
      - name: Create tarball
        run: |
          mkdir -p dist/zeropoint-agent
          cp zeropoint-agent dist/zeropoint-agent/
          if [ -d "web" ]; then cp -r web dist/zeropoint-agent/; fi
          tar -czf zeropoint-agent-${{ matrix.suffix }}.tar.gz -C dist zeropoint-agent
      
      - name: Generate OpenAPI spec
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          mkdir -p artifacts bin
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e VERSION="${{ github.event.release.tag_name }}" \
            -e ARTIFACTS_DIR="/workspace/artifacts" \
            zeropoint-agent-dev:latest \
            ./scripts/generate-swagger.sh
      
      - name: Generate client libraries
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e ARTIFACTS_DIR="/workspace/artifacts" \
            zeropoint-agent-dev:latest \
            ./scripts/generate-clients.sh
      
      - name: Create client tarballs
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          tar -czf zeropoint-agent-go-client.tar.gz -C artifacts/clients go
          tar -czf zeropoint-agent-typescript-client.tar.gz -C artifacts/clients typescript
          tar -czf zeropoint-agent-python-client.tar.gz -C artifacts/clients python
      
      - name: Upload binary
        uses: softprops/action-gh-release@v2
        with:
          files: zeropoint-agent-${{ matrix.suffix }}.tar.gz
      
      - name: Upload OpenAPI specs and clients (amd64 only)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/openapi.yaml
            artifacts/openapi.json
            artifacts/swagger.yaml
            artifacts/swagger.json
