name: Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Download dependencies
        run: go mod download
      
      - name: Install Swagger CLI
        run: go install github.com/swaggo/swag/cmd/swag@latest
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli@7.0.1
      
      - name: Build static binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build -v \
            -ldflags="-s -w -extldflags '-static' -X main.version=${{ github.event.release.tag_name }}" \
            -o zeropoint-agent \
            ./cmd/zeropoint-agent
      
      - name: Create tarball
        run: |
          tar -czf zeropoint-agent-${{ matrix.suffix }}.tar.gz zeropoint-agent
      
      - name: Generate OpenAPI spec
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        env:
          VERSION: ${{ github.event.release.tag_name }}
        run: ./scripts/generate-swagger.sh
      
      - name: Generate client libraries
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: ./scripts/generate-clients.sh
      
      - name: Create client tarballs
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          tar -czf zeropoint-agent-go-client.tar.gz -C artifacts/clients go
          tar -czf zeropoint-agent-typescript-client.tar.gz -C artifacts/clients typescript
          tar -czf zeropoint-agent-python-client.tar.gz -C artifacts/clients python
      
      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zeropoint-agent-${{ matrix.suffix }}.tar.gz
          asset_name: zeropoint-agent-${{ matrix.suffix }}.tar.gz
          asset_content_type: application/gzip
      
      - name: Upload OpenAPI spec (YAML)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/swagger.yaml
          asset_name: openapi.yaml
          asset_content_type: text/yaml
      
      - name: Upload OpenAPI spec (JSON)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./artifacts/swagger.json
          asset_name: openapi.json
          asset_content_type: application/json
      
      - name: Upload Go client
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zeropoint-agent-go-client.tar.gz
          asset_name: zeropoint-agent-go-client.tar.gz
          asset_content_type: application/gzip
      
      - name: Upload TypeScript client
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zeropoint-agent-typescript-client.tar.gz
          asset_name: zeropoint-agent-typescript-client.tar.gz
          asset_content_type: application/gzip
      
      - name: Upload Python client
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./zeropoint-agent-python-client.tar.gz
          asset_name: zeropoint-agent-python-client.tar.gz
          asset_content_type: application/gzip
